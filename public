<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>nc-buyboy-v2 overlay</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 16px; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
      .muted { opacity: 0.7; font-size: 12px; }
      .big { font-size: 18px; font-weight: 700; }
      code { font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="big">nc-buyboy-v2 live feed</div>
    <div class="muted">SSE endpoint, /events/stream</div>
    <div id="list"></div>

    <script>
      const list = document.getElementById("list");

      function addCard(evt) {
        const div = document.createElement("div");
        div.className = "card";

        const sig = evt.signature ? evt.signature.slice(0, 10) + "â€¦" : "no signature";
        const when = evt.receivedAt || "";
        const type = evt.type || "UNKNOWN";

        const tokenLine = evt.ncTokenDelta === null ? "" : `NC delta: ${evt.ncTokenDelta}`;
        const solLine = evt.solDelta === null ? "" : `SOL delta: ${evt.solDelta}`;

        div.innerHTML = `
          <div class="big">${type}</div>
          <div class="muted">${when}</div>
          <div>${evt.description || ""}</div>
          <div>${tokenLine}</div>
          <div>${solLine}</div>
          <div class="muted"><code>${sig}</code></div>
        `;

        list.prepend(div);

        // cap DOM size
        while (list.children.length > 30) list.removeChild(list.lastChild);
      }

      const es = new EventSource("/events/stream");

      es.addEventListener("snapshot", (msg) => {
        const arr = JSON.parse(msg.data);
        list.innerHTML = "";
        (arr || []).slice().reverse().forEach(addCard);
      });

      es.onmessage = (msg) => addCard(JSON.parse(msg.data));

      es.onerror = () => {
        console.log("SSE connection issue, browser will retry automatically");
      };
    </script>
  </body>
</html>

